---

- block:
    - name: check package state file
      stat:
        path: "{{ packages_state_file }}"
      register: packages_state_file_obj

    - name: load package state file
      include_vars:
        file: "{{ packages_state_file }}"
        name: package_state
      when: packages_state_file_obj.stat.exists

    - name: set empty package_state object
      set_fact:
        package_state: []
      when: not packages_state_file_obj.stat.exists|bool
  when: package_state is not defined

- name: set default value for package_condition
  set_fact:
    package_condition: false

- name: set package_condition variable
  set_fact:
    package_condition: "{{ package_state[state_package_name + '-' + state_package_version] }}"
  when: package_state[state_package_name + '-' + state_package_version] is defined

- name: "create state object for current package"
  set_fact:
    tmp_package_obj: '{ "{{ package_candidate.name }}-{{ package_candidate.version }}": { "checksum": "{{ package_candidate.checksum }}" }}'

- name: "add current package to list state list"
  set_fact:
    package_state: "{{ package_state|combine(tmp_package_obj) }}"

#- name: "add 'packages' prefix to package list object"
#  set_fact:
#    package_state:
#      state: "{{ package_state_obj }}"

- name: "transform package_state into nice yaml output"
  set_fact:
    package_state_yml: "{{ package_state | to_nice_yaml( width=50, explicit_start=True, explicit_end=True) }}"

- name: "write package_state file"
  copy:
    content: "{{ package_state_yml }}"
    dest: "{{ packages_state_file }}"
  become: true